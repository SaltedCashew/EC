<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>TeamKirk Transportation | Welcome</title>
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/flipclock.css">
    <link rel="stylesheet" href="css/jquery.dynatable.css" /> 
    <link rel="stylesheet" href="css/newtk.css" />
    <script src="js/vendor/modernizr.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="js/gmaps.js"></script>
    <script src="js/flipclock.js"></script>
    <script src="js/responsive-tables.js"></script>    
    <script src="js/jquery.dynatable.js"></script> 
  </head>

  <body>
    <div class = "top-banner-row">
      <div class="row" style="max-width: 95%">
       <h4>
        <a href="#" class = "left">TeamKirk Transportation </a>
       </h4>
      </div>
    </div>
    
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Begin Map Section ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
    <div class ="header-banner">

      <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Begin Map Display Code  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
     
        <div class="mapRow" > 
          <div class="hide-for-small" style="height:100%">
            <div id="map"> </div>
          </div>
          <div class="show-for-small-only" style="height:100%">
            <div id="map_small"></div>
            <img id ="map_static" src='img/edin.png' alt="static map background">
          </div>
        </div>
      
      <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End Map Display Code ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
      
      <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Begin Map Overlays ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
      <div class="rowFull">

        <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Timer & Location Block ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
        <div class="large-7 small-5 columns" style="pointer-events: none">
          <br>
          <div class="large-4point5 small-7 columns timerLocPanel">
            <div class="panel clockpanel">
              <div class = "row" >
                <div class="clock"></div>
              </div>
              <div class="row">
                <div class="large-12 small-6 columns">
                    <form id = "addressBox">
                    <input type ="text" id="postcode" placeholder="Enter your post code" style="width: 85%;margin-left: 5%">
                    <input class = "small round button searchButton" type="submit" value="Search for nearby bus stops">
                    </form>
                </div>
              </div>
              <div class="hide-for-small text-center">
                *Enter in your Post Code to Search for nearby bus stops. Use the list or map to select your desired bus stop.<br><br>
                *The timer will then count down until you need to leave your location to reach the bus on time.
              </div>
              <div class="show-for-small-only text-center">
                *Enter in your Post Code to Search for nearby bus stops. Use the list to select your desired bus stop.<br><br>
                *The timer will then count down until you need to leave your location to reach the bus on time.
              </div>
            </div>
          </div>
        </div>
        <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End Timer & Location Block ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
        

        <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Begin Info Table ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
        <div class="large-5 small-12 columns" style="pointer-events:none">
          <div class="large-5 small-5 tablepanel">
            <table id="busTable" class="info-table">
              <thead>
               <tr>
                  <th class="info-table-title" >Name</th>
                  <th class="info-table-title"  data-dynatable-column="distance">Distance (km)</th>
                  <th class="info-table-title" style="display:none">services</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div> 
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~End Info Table~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

      </div>
      <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End Map Overlays ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->         
  
    </div>
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End Map Section ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
            

    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Begin Lower / Footer Section ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
    <div class = "bottom-back">
      <footer class="row">
        <div class="large-12 columns " style="background-color: #333333">
          <hr>
          <div class="row"  style="background-color: #333333">
            <div class="large-6 columns">
              <p style="color: white">Â© Copyright: Team Kirk - Enterprise Computing</p>
            </div>
            <div class="large-6 columns">
              <ul class="inline-list right">
                <li><a href="#" data-reveal-id="about">About Us</a></li>
              </ul>
            </div>
          </div>
        </div>
      </footer> 
    </div>
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End Lower / Footer Section ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 



    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Begin About Us Pop-up Information ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
    <div id="about" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
      <h2 id="modalTitle">About Us</h2>
      <p><img class = "aboutImg" src="img/Edinburgh5.jpg" alt="Picture of Edinburgh"/></p>
      <p class="lead">We are Team Kirk</p>
      <ul>
        <li> Matthew Hepburn - Team Leader - API</li>
        <li>Sara Zhang - Back end NodeJS developer </li>
        <li>Mac Chong - Google Maps </li>
        <li>Brad Gray - Front-end foundation framework, Responsive design </li>
        <li>Paulius Gedminas - front end, Typescript, javascript, integration</li>
      </ul>  
      <p class = "text-center">Thank you, and enjoy your travels on Transport for Edinburgh</p>
      <a class="close-reveal-modal" aria-label="Close">&#215;</a>
      </div>
      <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End About Us Pop-up Information ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 



     <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Begin Scripts ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->     
    <!--~~~~~~~~~~~~~~~~~~~~~~~~ Start Gmaps Script ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~--> 
 
    <script type="text/javascript">

       // Working copy of function to write the table differently -------------------
      function ulWriter(rowIndex, record, columns, cellWriter) {
        var tr = '';
        // grab the record's attribute for each column
        for (var i = 0, len = columns.length-1; i < len; i++) {
          tr += cellWriter(columns[i], record);
        }
        td = editedCellWriter(columns[2], record);
        return '<tr style="font-weight:bold">' + tr + '</tr><tr>'+td+'</td></tr>';
      }

      //use for writing the services row
      function editedCellWriter(column, record) {
        var html = column.attributeWriter(record),
            td = '<td colspan="2"';
        var htmlAsString = html.join(', ');
        if (column.hidden || column.textAlign) {
          td += ' style="max-width:113px;font-weight:normal;word-wrap:break-word;';
          // keep cells aligned as their column headers are aligned
          if (column.textAlign) {
            td += 'text-align: ' + column.textAlign + ';';
          }
          td += '"';
        }
        return td + '>Serving:  ' + htmlAsString + '</td>';
      };
      // End working copy of functions for writing table  --------------------------

      kirk={
        calculateDistance: function(lon,lat){
          lat2 = kirk.locLatitude
          long2 = kirk.locLongitude
          dis = Math.sqrt((lat - lat2) * (lat - lat2) + (lon - long2) * (lon - long2)) * 3960 * 3.141592/180
          return dis;
        },
        init: function(){
          for(var i = 0; i<kirk.data.length; i++){
            var point = kirk.data[i]
            point.distance = kirk.calculateDistance(point.longitude, point.latitude);
            point.distance = (point.distance * 1.609344).toFixed(2);

            // console.log(point)
          }
        },
        filterMarkers: function(distance){
          var filteredPoints = []

          for( var i=0; i<kirk.data.length; i++){
            var point = kirk.data[i]
            if(kirk._isCloseEnough(point, distance)){
              filteredPoints.push(point)
            }
          }
          kirk.filtered = filteredPoints

        },
        _isCloseEnough: function(point, distance) {
          return point.distance < distance;
        },
        changeTable: function(){
          $( "#busTable" ).dynatable(
            {
              dataset: {
              records: kirk.filtered
            },
            features: {
              pushState: true,
              search: false,
              paginate: true,
              perPageSelect: false
            },
            writers: {
            _rowWriter: ulWriter
             },
          })

          var snap = $('#busTable').data('dynatable');
            snap.paginationPage.set(1); // Go to page 1
            snap.paginationPerPage.set(5);
            snap.process();
      }
     }
     
      $(document).ready(function(){
        map = new GMaps({
          div: '#map',
          lat: 55.952889,
          lng: -3.189591
      });
      kirk.defLatitude = map["map"]["center"]["k"];
      kirk.defLongitude = map["map"]["center"]["D"];

      GMaps.geolocate({
        success: function(position){
          map.setCenter(position.coords.latitude, position.coords.longitude);
          map.addMarker({
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            title: 'You are here.',
            infoWindow: { content: 'You are here!'    }
          });
          kirk.locLatitude = map["map"]["center"]["k"];
          kirk.locLongitude = map["map"]["center"]["D"];
          console.log("Actual: ",kirk);
          kirk.init();
          kirk.filterMarkers(0.5);
          kirk.changeTable();
          for(var i = 0; i< kirk.filtered.length; i++){
            map.addMarker({
              lat: kirk.filtered[i]["latitude"],
              lng: kirk.filtered[i]["longitude"],
              icon: "http://gmapsmarkergenerator.eu01.aws.af.cm/getmarker?scale=1&color=00ff00",
              title: kirk.filtered[i]["name"],
              infoWindow: { content: "<b>" + kirk.filtered[i]["name"] + "</b>" + "<br>" + "Services: " + kirk.filtered[i]["services"]}
            })
          }
        },
        error: function(error){
          alert('Geolocation failed: '+error.message);
        },
        not_supported: function(){
          alert("Your browser does not support geolocation");
        }
      });

      console.log("Default: ",kirk);

      $('#addressBox').submit(function(e){
        e.preventDefault();
        GMaps.geocode({
          address: $('#postcode').val().trim(),
          callback: function(results, status){
            if(status=='OK'){
              var latlng = results[0].geometry.location;
              map.setCenter(latlng.lat(), latlng.lng());
              map.removeMarkers();
              map.addMarker({
                lat: latlng.lat(),
                lng: latlng.lng()
              });
              kirk.locLatitude = map["map"]["center"]["k"];
              kirk.locLongitude = map["map"]["center"]["D"];
              kirk.init();
              kirk.filterMarkers(0.5);
              kirk.changeTable();
              for(var i = 0; i< kirk.filtered.length; i++){
                map.addMarker({
                  lat: kirk.filtered[i]["latitude"],
                  lng: kirk.filtered[i]["longitude"],
                  icon: "http://gmapsmarkergenerator.eu01.aws.af.cm/getmarker?scale=1&color=00ff00",
                  title: kirk.filtered[i]["name"],
                  infoWindow: { content: "<b>" + kirk.filtered[i]["name"] + "</b>" + "<br>" + "Services: " + kirk.filtered[i]["services"]}
                })
              }
              console.log("Address",kirk);
            }
          }
        });
      });

      $.get( "api/stops", function( data ) {
        kirk.data = data;
      });
    });

    </script>
    <!--~~~~~~~~~~~~~~~~~~~~~~~ End Gmaps Script ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

    <!--~~~~~~~~~~~~~~~~~~~~~ Start MacMaps Script ~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkAmuPTUzfsLsKVg4DUEQ4vFl89u_qNDk">
    </script>
    <script src="../maps/mapsts.js">
    google.maps.event.addDomListener(window, 'load', initialize);</script>
    <!--~~~~~~~~~~~~~~~~~~~~~~ End MacMaps Script ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
 
    <script type="text/javascript">
      var clock;
      $(document).ready(function() {
        clock = $('.clock').FlipClock(3000, {
        clockFace: 'MinuteCounter',
        autoStart: true,
        countdown: true
      });  });
    </script>
    <script src="js/flipclock/flipclock.min.js"></script>
    <script src="/js/vendor/fastclick.js"></script>
    <script src="/js/foundation.min.js"></script> 
    <script>
      $(document).foundation();
    </script>
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ End Scripts ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->     
    <p style="display:none"> please work </p>
  </body>
</html>